## 主从复制、主主复制
MySQL主从复制是其最重要的功能之一。主从复制是指一台服务器充当主数据库服务器，另一台或多台服务器充当从数据库服务器，主服务器中的数据自动复制到从服务器之中。MySQL主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新。



### 主从复制的作用

1. 做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。
2. 架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。（请求发到多部机子上）
3. 读写分离，使数据库能支撑更大的并发。一主多从的部署方案，将涉及数据写的操作放在Master端操作，而将数据读的操作分散到众多的Slave当中。降低了Master的负载，提高数据写入的响应效率；多台从服务器提供读，分担了请求，提高了读的效率。在报表中尤其重要。由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。

 

### 主从复制的原理

1. 数据库有个bin-log二进制文件，记录了所有sql语句。
2. 我们的目标就是把主数据库的bin-log文件的sql语句复制过来。
3. 让其在从数据的relay-log重做日志文件中再执行一次这些sql语句即可。

 

### 主从复制步骤以及涉及的线程：

一. 主库db的更新事件(update、insert、delete)被写到binlog<br>
二. 从库发起连接，连接到主库<br>
三. 此时主库创建一个binlog dump thread线程，把binlog的内容发送到从库<br>
四. 从库启动之后，创建一个I/O线程，读取主库传过来的binlog内容并写入到relay log.<br>
五. 还会创建一个SQL线程，从relay log里面读取内容，从Exec_Master_Log_Pos位置开始<br>

1.binlog输出线程:每当有从库连接到主库的时候，主库都会创建一个线程输出binlog，然后发送binlog内容到从库。<br>
2.从库I/O线程:当START SLAVE语句在从库开始执行之后，从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。（从主库先传输下来）从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件（再更新relay log）。<br>
3.从库的SQL线程:从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。<br>

 

### 做主从后主服务器挂了怎么办

假设发生了突发事件，master宕机，现在的需求是要将从库提升为主库，另外一个为从库：

1. 确保所有的从库的relay log全部更新完毕，在每个从库上执行stop slave io_thread; show processlist;直到看到Has read all relay log,则表示从库更新都执行完毕了<br>
2. 登陆所有从库，查看master.info文件，选择一个从库为新的主库<br>
3. 登陆该从库，执行stop slave; 并进入数据库目录，删除master.info和relay-log.info文件, 配置my.cnf文件，开启log-bin,如果有log-slaves-updates和read-only则要注释掉，执行reset master<br>
4. 创建用于同步的用户并授权slave，同第五大步骤<br>
5. 登录另外一台从库，执行stop slave停止同步<br>
6. 根据第七大步骤连接到新的主库<br>
7. 执行start slave;<br>
8. 修改新的master数据，测试slave是否同步更新<br>

### 主从复制延迟

主库针对读写操作，顺序写 binlog，从库单线程去主库读"写操作的binlog",从库取到 binlog在本地原样执行(随机写),来保证主从数据逻辑上一致.mysql的主从复制都是单线程的操作，主库对所有DDL和DML产生 binlog，binlog是顺序写，所以效率很高，slave的Slave_IO_Running线程到主库取日志，效率比较高，下一步问题来了，slave的 slave_sql_running线程将主库的 DDL和DML操作在 slave实施。DML，DDL的IO操作是随机的，不能顺序的，成本高很多，还有可能slave上的其他查询产生 lock，由于 slave_sql_running也是单线程的，所以 一个 DDL卡住了，需求需求执行一段时间，那么所有之后的DDL会等待这个 DDL执行完才会继续执行，这就导致了延迟.由于master可以并发，Slave_sql_running线程却不可以，所以主库执行 DDL需求一段时间，在slave执行相同的DDL时，就产生了延迟.<br>

#### 主从同步延迟产生原因
当主库的TPS并发较高时，产生的DDL数量超过Slave一个 sql线程所能承受的范围，那么延迟就产生了，当然还有就是可能与 slave的大型 query语句产生了锁等待<br>
首要原因：数据库在业务上读写压力太大，CPU计算负荷大，网卡负荷大，硬盘随机IO太高<br>
次要原因：读写 binlog带来的性能影响，网络传输延迟<br>

#### 主从同步延迟解决方案
架构方面：mysql压力变小，延迟自然会变小<br>
1.  业务的持久化层的实现采用分库架构，mysql服务可平行扩展分散压力<br>
2.  单个库读写分离，一主多从，主写从读，分散压力。<br>
3.  服务的基础架构在业务和mysql之间加放 cache层<br>
4.  不同业务的mysql放在不同的机器<br>
5.  使用比主加更好的硬件设备作slave<br>

## 读写分离
MySQL的主从复制和MySQL的读写分离两者有着紧密联系，首先部署主从复制，只有主从复制完了，才能在此基础上进行数据的读写分离。读写分离就是只在主服务器上写，只在从服务器上读，基本的原理是让主数据库处理事务性查询，而从数据库处理select查询，数据库复制被用来把事务性查询导致的改变更新同步到集群中的从数据库，即主从复制。

1. 基于程序代码内部实现<br>
在代码中根据select,insert进行路由分类，这类方法也是目前生产环境应用最广泛的，优点是性能好，因为在程序代码中实现，不需要曾加额外的设备作为硬件开支，缺点是需要开发人员来实现，运维人员无从下手。<br>
2. 基于中间代理层实现<br>
代理一般位于客户端和服务器之间，代理服务器接到客户端请求后通过判断后转发到后端数据库，有两个代表性程序。<br>
&ensp;（1）mysql-proxy 为mysql开源项目，通过其自带的lua脚本进行SQL判断，虽然是mysql的官方产品，但是mysql官方不建议将其应用到生产环境<br>
&ensp;（2）Amoeba （变形虫）由陈思儒开发，曾就职与阿里巴巴，该程序由java语言进行开发，阿里巴巴将其应用于生成环境，它不支持事物和存储过程<br>
通过程序代码实现mysql读写分离自然是一个不错的选择，但是并不是所有的应用都适合在程序代码中实现读写分离，像一些大型复杂的java应用，如果在程序代码中实现读写分离对代码改动就较大，像这种应用一般会考虑使用代理层来实现。<br>

 

MySQL Proxy是一个处于你的client端和MySQL server端之间的简单程序，它可以监测、分析或改变它们的通信。它使用灵活，没有限制，常见的用途包括：负载平衡，故障、查询分析，查询过滤和修改等等。MySQL Proxy就是这么一个中间层代理，简单的说，MySQL Proxy就是一个连接池，负责将前台应用的连接请求转发给后台的数据库，并且通过使用lua脚本，可以实现复杂的连接控制和过滤，从而实现读写分离和负载平衡。对于应用来说，MySQL Proxy是完全透明的，应用则只需要连接到MySQL Proxy的监听端口即可。当然，这样proxy机器可能单点失效，但完全可以使用多个proxy机器做为冗余，在应用服务器的连接池配置中配置到多个proxy的连接参数即可。MySQL Proxy更强大的一项功能是实现“读写分离”，基本原理是让主数据库处理事务性查询，让从库处理SELECT查询。数据库复制被用来把事务性查询导致的变更同步到集群中的从库。


读写分离的好处：<br>
1. 物理服务器增加，负荷增加<br>
2. 主从只负责各自的写和读，极大程度的缓解X锁和S锁争用<br>
3. 从库可配置myisam引擎，提升查询性能以及节约系统开销<br>
4. 从库同步主库的数据和主库直接写还是有区别的，通过主库发送来的binlog恢复数据，但是，最重要区别在于主库向从库发送binlog是异步的，从库恢复数据也是异步的<br>
5. 读写分离适用与读远大于写的场景，如果只有一台服务器，当select很多时，update和delete会被这些select访问中的数据堵塞，等待select结束，并发性能不高。 对于写和读比例相近的应用，应该部署双主相互复制<br>
6. 可以在从库启动是增加一些参数来提高其读的性能，例如`--skip-innodb、--skip-bdb、--low-priority-updates`以及`--delay-key-write=ALL` 当然这些设置也是需要根据具体业务需求来定得，不一定能用上<br>
7. 分摊读取。假如我们有1主3从，不考虑上述1中提到的从库单方面设置，假设现在1 分钟内有10条写入，150条读取。那么，1主3从相当于共计40条写入，而读取总数没变，因此平均下来每台服务器承担了10条写入和50条读取（主库不承担读取操作）。因此，虽然写入没变，但是读取大大分摊了，提高了系统性能。另外，当读取被分摊后，又间接提高了写入的性能。所以，总体性能提高了，说白 了就是拿机器和带宽换性能。MySQL官方文档中有相关演算公式：官方文档 见6.9FAQ之“MySQL复制能够何时和多大程度提高系统性能”<br>
8. MySQL复制另外一大功能是增加冗余，提高可用性，当一台数据库服务器宕机后能通过调整另外一台从库来以最快的速度恢复服务，因此不能光看性能，也就是说1主1从也是可以的。<br>

 
[资料来源](https://www.cnblogs.com/LUO77/p/8574354.html)